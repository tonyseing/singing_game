/* EntityJS v0.4.4 entityjs.com | License entityjs.com/license */
re=function(t){return new re.query(t)},re.version="0.4.4",re._e=[],re._c={},re.ready=function(t){re.listener("load",t)},re.$=function(t){return re.$._[t]=re.$._[t]||("#"==t.charAt(0)?document.getElementById(t.substr(1)):document.getElementsByTagName(t)[0])},re.$._={},re.$new=function(t){return document.createElement(t)},re.listener=function(t,e,i){(i||window).addEventListener(t,e,!0)},re.is=function(t,e){return 1==arguments.length?null!=t:null!=t&&Object.prototype.toString.call(t).slice(8,-1).toLowerCase()==e.toLowerCase()},re.comp=re.c=function(t,e){if(re._c[t]||(re._c[t]=new re.c.init(t)),e)for(var i in e)re._c[t][i](e[i]);return re._c[t]},re.c.init=function(t){if(this.name=t,this._re_listens={},this._re_defaults={},this._re_defines={},this._re_events={},this._re_final=0,!re[this.name]){var e=this;re[this.name]=function(){return e._re_method.apply(e,arguments)}}},re.c.init.prototype={z:function(t,e){return this._checkFinal(),this[t]||(this[t]=[]),this[t]=re.is(e,"string")?this[t].concat(e.split(" ")):this[t].concat(e),this},_checkFinal:function(){if(this._re_final)throw this.name+" is final."},singleton:function(){return this._re_method=function(){return this._singleton||(this._singleton=re.e(this.name))},this},statics:function(t,e){if(this._checkFinal(),re.is(e))re[this.name][t]=e;else for(var i in t)re[this.name][i]=t[i];return this},events:function(t,e){if(this._checkFinal(),re.is(e))this._re_events[t]=e;else for(var i in t)this._re_events[i]=t[i];return this},factory:function(t){return this._checkFinal(),this._re_factory=t,this},_re_method:function(){var t=re.e(this.name),e=this._re_factory;return e?e.apply(t,arguments):t.attr.apply(t,arguments),t},method:function(t){return this._re_method=t.bind(re[this.name]),this},requires:function(t){return this.z("_re_requires",t)},asserts:function(t){return this.z("_re_asserts",t)},interfaces:function(t){return this.z("_re_interfaces",t)},alias:function(t){this._checkFinal();var e=t.split(" ");if(e.length>1){for(var i in e)this.alias(e[i]);return this}return"-"==t.charAt(0)?re._c[t.substr(1)]==this&&delete re._c[t.substr(1)]:re._c[t]=this,this},on:function(){return re.e.init.prototype.on.apply(this,arguments)},off:function(){return re.e.init.prototype.off.apply(this,arguments)},trigger:function(){return re.e.init.prototype.trigger.apply(this,arguments)},defaults:function(t,e){if(this._checkFinal(),1==arguments.length)for(var i in t)this._re_defaults[i]=t[i];else this._re_defaults[t]=e;return this},namespaces:function(t,e){this._checkFinal();var i=this.name+"_";if(1==arguments.length)for(var s in t)this._re_defines[i+s]=t[s];else this._re_defines[i+t]=e;return this},defines:function(t,e){if(this._checkFinal(),1==arguments.length)for(var i in t)this._re_defines[i]=t[i];else this._re_defines[t]=e;return this},init:function(t){return this._checkFinal(),this._re_init=t,this},dispose:function(t){return this._checkFinal(),this._re_dispose=t,this},lock:function(){return this._checkFinal(),this._re_final=1,this},run:function(t){return this._checkFinal(),t.call(this),this}},function(t){var e=function(e,i,s){if(!i){var r=new t.entity.init(e);return s||t._e.push(r),r}for(var n=t(),o=0;i>o;o++)n.push(t.e(e,0,s));return n},i=function(t){this._re_comps=[],this._re_listens={},this.comp(t)},s=i.prototype;s.comp=function(t){if(this._re_comp(t),this._re_interfaces)for(var e in this._re_interfaces)if(!this.hasOwnProperty(this._re_interfaces[e]))throw"Interface: "+this._re_interfaces[e]+" missing";if(this._re_asserts)for(var i in this._re_asserts)if(-1!=this._re_comps.indexOf(this._re_asserts[i]))throw"Assert: "+this._re_asserts[i]+" is not allowed";return this},s.removeComp=function(e){var i;if(i=t.is(e,"array")?e:e.split(" "),i.length>1){for(var s;s=i.shift();)this.removeComp(s);return this}if(e=i[0],e&&this.has(e)){var r=t._c[e];r&&(r._re_dispose&&r._re_dispose.call(this,r),r.trigger("dispose",this)),this._re_comps.splice(this._re_comps.indexOf(e),1)}return this},s._re_comp=function(e){if(!e)return this;var i;if(i=t.is(e,"array")?e:e.split(" "),i.length>1){for(var s=0;s<i.length;s++)this._re_comp(i[s]);return this}if(e=i[0],!e)return this;var r,n=e.split(":");return e=n[0],n.shift(),r=t._c[e],this.has(e)||(this._re_comps.push(e),r&&(this._re_comp(r._re_requires),r._re_interfaces&&(this._re_interfaces||(this._re_interfaces=[]),this._re_interfaces=this._re_interfaces.concat(r._re_interfaces)),r._re_asserts&&(this._re_asserts||(this._re_asserts=[]),this._re_asserts=this._re_asserts.concat(r._re_asserts)),r._re_defaults&&this.def(r._re_defaults),r._re_defines&&this.attr(r._re_defines),r._re_events&&this.attr(r._re_events).on(r._re_events),r._re_init&&r._re_init.apply(this,n),r.trigger("init",this))),this},s.comps=function(){return this._re_comps.slice()},s.clone=function(e,i){return t.e(this._re_comps,e,i)},s._super=function(e,i){var s=Array.prototype.slice.call(arguments,2);if(""==e)return t.e.init.prototype[i].apply(this,s);var r=t._c[e];return r._re_defines[i]?r._re_defines[i].apply(this,s):r._re_defaults[i].apply(this,s)},s.has=function(e){for(t.is(e,"string")&&(e=t.query._toObj(e)),e.comp=e.comp||[],e.id=e.id||"",e.on=e.on||[],e.not=e.not||[],s=0;s<e.comp.length;s++)if(-1==this._re_comps.indexOf(e.comp[s]))return!1;for(s=0;s<e.not.length;s++)if(-1!=this._re_comps.indexOf(e.not[s]))return!1;var i;for(s=0;s<e.on.length;s++)if(i=e.on[s],!this._re_listens[i]||0==this._re_listens[i].length)return!1;return""!=e.id&&this.id!=e.id?!1:!0},s.on=function(e,i,s,r){if(t.is(e,"object"))for(var n in e)this.on(n,e[n],i,s);else{if(this._re_listens[e]||(this._re_listens[e]=[]),!t.is(i))throw"Method is null";this._re_listens[e].push({c:s||this,f:i,o:r})}return this},s.once=function(t,e,i){return this.on(t,e,i,1)},s.off=function(e,i){if(t.is(e,"object"))for(var s in e)e.hasOwnProperty(s)&&this.off(s,e[s]);else if(i){var r=this._re_listens[e];for(var s in r)r[s].f==i&&r.splice(s,1)}else e?this._re_listens[e]=[]:this._re_listens={};return this},s.trigger=function(t){if(!this._re_listens[t])return this;for(var e,i=0,s=this._re_listens[t].length;s>i&&(e=this._re_listens[t],e);i++)e[i]&&(e[i].f.apply(e[i].c,Array.prototype.slice.call(arguments,1))===!1||e[i]&&e[i].o)&&e.splice(i,1);return this},s.attr=s.set=function(e,i){if(t.is(e,"object"))for(var s in e)this.attr(s,e[s]);else{var r="function";t.is(this[e],r)&&!t.is(i,r)?t.is(i,"array")?this[e].apply(this,i):this[e].call(this,i):this[e]=i}return this},s.get=function(e){return t.is(this[e],"function")?this[e]():this[e]},s.def=function(e,i){if(t.is(e,"object"))for(var s in e)this.def(s,e[s]);else t.is(this[e])||(this[e]=i);return this},s.dispose=function(){var e="dispose";return this.removeComp(this.comps()),this.trigger(e),this.off(),t._e.splice(t._e.indexOf(this),1),this},t.entity=t.e=e,t.entity.init=i}(re),function(t){var e=function(e){return new t.load.init(e)};e.path="",e.file=function(t){return t.split("/").pop().split("?").shift()},e.imageExt="img",e.soundExt="sfx",e.images=["gif","jpg","jpeg","png"],e.sounds=["wav","mp3","aac","ogg"];var i=function(e){if(t.is(e,"string"))this.assets=e.split(" ");else if(t.is(e,"object")){this.assets=[];for(var i in e)t.is(e[i],"array")&&(this.assets=this.assets.concat(e[i]))}else this.assets=e;for(var s,i=0;i<this.assets.length;i++){this.total++,s=this.assets[i];var r=s.match(/^(\/|http:)/)?s:t.load.path+s;s=t.load.file(s);var n=s.lastIndexOf(".")+1,o=s.substr(n).toLowerCase(),h=s.substr(0,n);if(-1!=t.load.images.indexOf(o))this._loadImg(r,s,h);else if(-1!=t.load.sounds.indexOf(o)){if(!(window.soundManager&&"mp3"==o||t.support(o))){this.total--;continue}if(t._c[h+t.load.soundExt]){this.total--;continue}this._loadSound(r,s,h)}}return this},s=i.prototype;s.current=0,s.total=0,s._loadImg=function(e,i,s){var r=this,n=new Image;return t.c(i).alias(s+t.load.imageExt).defines({_image:n}).image=n,n.onload=function(){t.c(i).defines({sizeX:n.width,sizeY:n.height,bisect:n.width}),r._loaded()},n.crossOrigin="",n.onerror=function(){r._e&&r._e.call(r,i)},n.src=e,this},s._loaded=function(){this.current++,this.current<=this.total&&this._p&&this._p(this.current,this.total,this.assets[this.current-1]),this.current==this.total&&this._s&&this._s(this.assets)},s._loadSound=function(t,e,i){var s,r=this;if(window.soundManager)soundManager.onready(function(){s=soundManager.createSound({id:e,url:t,autoLoad:!0,onload:function(){r._loaded()}}),r._def_sfx(s,e,i)});else{s=new Audio,s.preload="auto",s.load();var n=function(){r._loaded(),s.removeEventListener("canplaythrough",n)};s.addEventListener("canplaythrough",n,!1),s.addEventListener("error",function(){r._e&&r._e.call(r,e)},!1),s.src=t,this._def_sfx(s,e,i)}},s._def_sfx=function(e,i,s){t.c(i).alias(s+t.load.soundExt).defines({_sound:e}).sound=e},s.progress=function(t){return this._p=t,this},s.complete=function(t){return this._s=t,0==this.assets.length&&t([]),this},s.error=function(t){return this._e=t,this},t.load=e,t.load.init=i}(re),function(t){var e=function(t){t&&this.query(t)};e._toObj=function(t){if(e.c[t])return e.c[t];for(var i,s,r=t.split(" "),n=[],o=[],h=[],a="",c=r.length;c--;)i=r[c].charAt(0),s=r[c].substr(1),"^"==i?o.push(s):"!"==i?h.push(s):"#"==i?a=s:n.push(r[c]);var u={comp:n,on:o,not:h,id:a};return e.c[t]=u,u},e.c={};var i=e.prototype=new Array;i.query=function(i){i=i||"";var s,r=t._e.length,n=-1;if(t.is(i,"string")){if("*"==i)return this.push.apply(this,t._e.slice()),this;for(var o=e._toObj(i);++n<r&&(s=t._e[n]);)s.has(o)&&this.push(s)}else if(t.is(i,"function"))for(;++n<r&&(s=t._e[n]);)i.call(s,n,r)&&this.push(s);else t.is(i,"array")&&this.push.apply(this,i);return this},i.invoke=function(t){var e=Array.prototype.slice.call(arguments,1);return this.each(function(i){i[t].apply(i,e)})},i.each=function(t,e){for(var i,s=this.length,r=-1;++r<s&&null!=(i=this[r])&&t.call(e||this,i,r,this)!==!1;);return this},i.tilemap=function(t,e,i){var s=0,r=0;return this.each(function(n){return 0==e.call(i,this[n],s,r,n,this)?!1:(s++,s==t&&(s=0,r++),void 0)})},i.comps=function(){var t=[];return this.each(function(e){for(var i=e.comps(),s=0;s<i.length;s++)-1==t.indexOf(i[s])&&t.push(i[s])}),t},i.random=function(){return this[0|Math.random()*this.length]},i.attr=function(t,e){return this.invoke("attr",t,e)},i.def=function(t,e){return this.invoke("def",t,e)},i.comp=function(t){return this.invoke("comp",t)},i.removeComp=function(t){return this.invoke("removeComp",t)},i.on=function(t,e){return this.invoke("on",t,e)},i.off=function(t,e){return this.invoke("off",t,e)},i.trigger=function(){var t=arguments;return this.each(function(e){e.trigger.apply(e,t)})},i.has=function(t){return this.length?this.every(function(e){return e.has(t)}):!1},i.pluck=function(t){var e=[],i=t.split(" ");return this.each(function(t){var s={};for(var r in i){var n=i[r];s[n]=t[n]}e.push(s)}),e},i.isEmpty=function(){return!this.length},i.find=function(t,e){for(var i=0,s=this.length;s>i;i++)if(t.call(e||this,this[i],i,this))return this[i];return null},i.min=function(t,e){var i,s=1/0;return this.each(function(r,n,o){var h=t.call(e||this,r,n,o);s>h&&(s=h,i=r)}),i},i.max=function(t,e){var i,s=-1/0;return this.each(function(r,n,o){var h=t.call(e||this,r,n,o);h>s&&(s=h,i=r)}),i},i.sum=function(t,e){var i=0;return this.each(function(s,r,n){i+=t.call(e||this,s,r,n)}),i},i.filter=function(){return t(Array.prototype.filter.apply(this,arguments))},i.reject=function(t,e){for(var i=0;i<this.length;i++)t.call(e||this,this[i],i,this)&&this.splice(i,1);return this},i.findWith=function(t){return this.find(function(e){return e.has(t)})},i.e=function(e,i,s){var r=t.e(e,i,s);if(i)for(var n in r)this.push(r[n]);else this.push(r);return this},i.include=function(t){return-1!=this.indexOf(t)},i.erase=function(t){for(var e=0;e<this.length;e++)this[e]==t&&this.splice(e,1);return this},i.insertAfter=function(t,e){return this.splice(this.indexOf(t)+1,0,e),this},i.insertBefore=function(t,e){return this.splice(this.indexOf(t),0,e),this},i.swap=function(t,e){var i=this.indexOf(t),s=this.indexOf(e),r=this[i];return this[i]=e,this[s]=r,this},i.dispose=function(){return this.each(function(t){t.dispose()})},i.first=function(){return arguments.length?(this.unshift.apply(this,arguments),this):this[0]},i.last=function(){return arguments.length?(this.push.apply(this,arguments),this):this[this.length-1]},t.query=e}(re),re.c("system").defaults({clearColor:"#f9f9f9",stepSize:.03,maxTick:.05,running:!1,sizeX:10,sizeY:10}).defines({clear:function(t){return t?(this.context.fillStyle=t,this.context.fillRect(0,0,this.sizeX,this.sizeY)):this.context.clearRect(0,0,this.sizeX,this.sizeY),this},start:function(){if(!this.running){this.running=!0;var t=this;!function e(){t.system_loop(),t.running&&t.requestAnimationFrame(e,t.canvas)}()}return this},loop:function(t){return this.system_loop=t,this},stop:function(){return this.running=!1,this},init:function(t,e){this.comp("polyfill tick timestep"),this.canvas=re.is(t,"htmlcanvaselement")?t:re.$(t),this.context=this.canvas.getContext(e||"2d");var i=re.screen=re.e("screen");return this.sizeX=i.sizeX=this.canvas.width,this.sizeY=i.sizeY=this.canvas.height,re.keyboard&&re.keyboard.i(),re.mouse&&re.mouse.i(),re.touch&&re.touch.i(),this.system_loop=this.defaultLoop,this.second=30*this.stepSize,this},defaultLoop:function(){this.timestep(Math.min(this.tick()/1e3,this.maxTick),function(){this.update()}),this.clear(this.clearColor),this.draw()},update:function(){re.update.update(this.stepSize)},draw:function(){re.drawlist().drawlist(this.context)}}),re.system=re.sys=re.e("system"),re.c("drawlist").method(function(t){var t=t||"";return re.drawlist._lists[t]||re.e("drawlist:"+t),re.drawlist._lists[t]}).statics({_lists:{}}).defines({add:function(t){return t.drawlist&&t.drawlist.remove(t),t.drawlist=this,this.list.last(t),this},remove:function(t){return t.drawlist&&(this.list.erase(t),t.drawlist=null),this},drawlist:function(t){for(var e,i=this.list,s=0;s<i.length;s++)e=i[s],e.visible()&&e.render(t)},sort:function(){this.list.sort(function(t,e){return t.depth&&e.depth?t.depth()-e.depth():0})}}).init(function(t){re.drawlist._lists[t]=this,this.listName=t,this.list=re()}).dispose(function(){delete re.drawlist._lists[this.listName]}),re.c("tick").init(function(){this.lastTime=Date.now()}).defines({tick:function(){var t=Date.now(),e=this.lastTime;return this.lastTime=t,t-e}}),re.c("tween").requires("update").namespaces({update:function(t){if(this.tweening){this.tween_time+=t;var e=this.tween_time/this.tween_t;e>1&&(e=1),value=this.tweenEase(e);for(var i in this.tween_d){var s=this.tween_s[i]+this.tween_d[i]*value;re.is(this[i],"function")?this[i](s):this[i]=s}this.trigger("tween:update",value),1==e&&(this.tweening=!1,this.off("update",this.tween_update),this.trigger("tween:finish"))}}}).defaults({tweening:!1,tweenEase:function(t){return t}}).defines({tween:function(t,e){t>=100&&(t/=1e3);var i=(t||1)/re.sys.second;this.tween_time=0;var s={},r={};for(var n in e){var o=this[n];re.is(o,"function")&&(o=o()),s[n]=e[n]-o,r[n]=o}return this.tween_s=r,this.tween_d=s,this.tween_t=i,this.tweening||this.on("update",this.tween_update),this.tweening=!0,this.trigger("tween:start",r)}}),re.tween=function(t,e,i){return t.comp("tween").tween(e,i)},re.c("update").statics({l:[],update:function(t){for(var e,i=this.l,s=0;s<i.length;s++)e=i[s],e&&e.updatable&&e.trigger("update",t)}}).defaults({updatable:!0}).defines(function(){var t=re.update.l;return{updateFirst:function(){return t.splice(t.indexOf(this),1),t.unshift(this),this},updateLast:function(){return t.splice(t.indexOf(this),1),t.push(this),this},updateAfter:function(e){var i=t.indexOf(e),s=t.indexOf(this);if(i>s){var r=t[i];t[i]=t[s],t[s]=r}return this},updateBefore:function(e){var i=t.indexOf(e),s=t.indexOf(this);if(s>i){var r=t[i];t[i]=t[s],t[s]=r}return this}}}()).init(function(){re.update.l.push(this)}).dispose(function(){re.update.l.splice(re.update.l.indexOf(this),1)}),re.c("align").defaults({regX:0,regY:0,sizeX:1,sizeY:1,posX:0,posY:0}).defines({align:function(t,e){return this.alignHor(t),this.alignVer(e)},alignHor:function(t){return t=t||0,this.set("posX",0|.5*re.sys.sizeX-.5*(this.get("sizeX")-this.get("regX"))+t),this},alignVer:function(t){return t=t||0,this.set("posY",0|.5*re.sys.sizeY-.5*(this.get("sizeY")-this.get("regY"))+t),this},alignRight:function(t){return t=t||0,this.set("posX",0|re.sys.sizeX-(this.get("sizeX")-this.get("regX"))+t),this},alignLeft:function(t){t=t||0;var e=this.get("sizeX");return this.set("posX",0|t+e-(e-this.get("regX"))),this},alignTop:function(t){t=t||0;var e=this.get("sizeY");return this.set("posY",0|t+e-(e-this.get("regY"))),this},alignBottom:function(t){return t=t||0,this.set("posY",0|re.sys.sizeY-(this.get("sizeY")-this.get("regY"))+t),this}}),re.c("animate").requires("flicker").defines({flicker_stop:function(){this._super("flicker","flicker_stop"),this.animate_finish&&this.animate_finish()},animate:function(t,e,i){if(this.flickering()!=t){this.animate_finish=e,this.animate_update=i;var s=this.animates[t];this.flicker(s[0],s[1],s[2],t),s.push&&this.flicker_run()}return this},animating:function(t){return this.flickering(t)},flick:function(t){this.frame(t),this.animate_update&&this.animate_update.apply(this,arguments)}}),re.c("circle").requires("draw").defaults({color:"#82d5f4"}).defines({draw:function(t){t.fillStyle=this.color,t.beginPath();var e=this.get("radius");return t.arc(-this.regX+e,-this.regY+e,e,0,2*Math.PI,!0),t.closePath(),t.fill(),this},radius:function(t){return re.is(t)?(this.sizeX=this.sizeY=2*t,this):.5*this.sizeX}}),re.c("draw").interfaces("draw").init(function(){re.drawlist().add(this)}).dispose(function(){this.drawlist.remove(this)}).defaults({screenable:!0,drawable:!0,rotation:0,alpha:1,scaleX:1,scaleY:1,posX:0,posY:0,sizeX:10,sizeY:10,regX:0,regY:0}).defines({depth:function(){return this.posY},drawFirst:function(){var t=this.drawlist.list;return t.splice(t.indexOf(this),1),t.unshift(this),this},drawLast:function(){var t=this.drawlist.list;return t.splice(t.indexOf(this),1),t.push(this),this},drawAfter:function(t){var e=this.drawlist.list,i=e.indexOf(t),s=e.indexOf(this);if(i>s){var r=e[i];e[i]=e[s],e[s]=r}return this},drawBefore:function(t){var e=this.drawlist.list,i=e.indexOf(t),s=e.indexOf(this);if(s>i){var r=e[i];e[i]=e[s],e[s]=r}return this},screenX:function(t){return t?(this.posX=t+re.screen.posX,this):this.posX-re.screen.posX},screenY:function(t){return t?(this.posY=t+re.screen.posY,this):this.posY-re.screen.posY},render:function(t){this.draw_before(t),this.draw(t),this.draw_after(t)},visible:function(){return this.drawable&&re.screen.hit(this.posX,this.posY,this.sizeX,this.sizeY)}}).namespaces({before:function(t){t.save(),this.alpha-1&&(t.globalAlpha=this.alpha),this.screenable?t.translate(this.screenX(),this.screenY()):t.translate(this.posX,this.posY),this.rotation&&t.rotate(this.rotation*Math.PI/180),(1!=this.scaleX||1!=this.scaleY)&&t.scale(this.scaleX,this.scaleY)},after:function(t){t.restore()}}),re.c("el").requires("align").defines({posX:function(t){return re.is(t)?(this.$el.css("left",t),this):this.$el.position().left},posY:function(t){return re.is(t)?(this.$el.css("top",t),this):this.$el.position().top},sizeX:function(){return this.$el.outerWidth()},sizeY:function(){return this.$el.outerHeight()},click:function(t){var e=this;return this.$el.click(function(i){t.call(e,i)}),this},$:function(t,e){return this.$el.find(t,e)},setEl:function(t){return this.removeEl(),this.el=t,this.$el=$(t).addClass("el"),this.posX(0),this.posY(0),this},text:function(t){return re.is(t)?(this.$el.text(t),this):this.$el.text()},addEl:function(t){return t=t||$(re.sys.canvas).parent(),t.append(this.el),this},removeEl:function(){return this.$el&&this.$el.remove(),this},hide:function(){return this.$el.hide(),this},show:function(){return this.$el.show(),this}}).init(function(t){t&&this.setEl(re.$new(t))}).dispose(function(){this.removeEl()}),re.c("image").requires("draw").defines({image:function(t){return re.is(t)?(this.attr({_image:t,sizeX:t.width,sizeY:t.height,bisect:t.width}),this):this._image},visible:function(){return this._image&&this._super("draw","visible")},draw:function(t){return t.drawImage(this._image,-this.regX,-this.regY,this.sizeX,this.sizeY),this}}).init(function(){this._image&&this.image(this._image)}),re.c("imgtext").requires("draw").interfaces("imgtext").defaults({charOffset:32,lineHeight:15}).defines({visible:function(){return this._text&&this._image&&this._super("draw","visible")},draw:function(t){for(var e=0;e<this.text_lines.length;e++)this.drawText(t,this.text_lines[e],e*this.lineHeight);return this},drawText:function(t,e,i){for(var s,r,n,o=0,h=0,a=e.length;a>h;++h){if(r=e.charCodeAt(h)-this.charOffset,s=this.imgtext[r],!this.charCache[r]){n=0;for(var c=0;r>c;++c)n+=this.imgtext[c]+1;this.charCache[r]=n}t.drawImage(this._image,this.charCache[r],0,s,this._image.height,-this.regX+o,-this.regY+i,s,this._image.height),o+=s}},text:function(t){if(re.is(t)){this._text=t,this.text_lines=this._text.split("\n"),this.sizeX=0;for(var e in this.text_lines){for(var i=0,s=0;s<this.text_lines[e].length;s++)i+=this.imgtext[s];i>this.sizeX&&(this.sizeX=i)}return this.sizeY=this.text_lines.length*this.lineHeight,this}return this._text}}).init(function(){this.charCache||(this.charCache={}),this.text("")}),re.c("rect").requires("draw").defaults({color:"#82d5f4"}).defines({draw:function(t){return t.fillStyle=this.color,t.fillRect(-this.regX,-this.regY,this.sizeX,this.sizeY),this}}),re.c("screen").requires("hit").defines({pos:function(t,e){return arguments.length?(re.is(t,"object")&&(e=t.posY,t=t.posX),this.posX=t-this.regX,this.posY=e-this.regY,this):this},toScreenX:function(t){return t+this.posX+this.offX},toScreenY:function(t){return t+this.posY+this.offY}}).defaults({posX:0,posY:0,regX:0,regY:0,sizeX:0,sizeY:0,offX:0,offY:0}),re.c("sprite").requires("image bisect").defaults({frameX:0,frameY:0}).defines({frame:function(t){return re.is(t)?(this.frameX=this.biToTileX(t),this.frameY=this.biToTileY(t),this):this.tileToBi(this.frameX,this.frameY)},draw:function(t){return t.drawImage(this._image,this.frameX*this.sizeX,this.frameY*this.sizeY,this.sizeX,this.sizeY,-this.regX,-this.regY,this.sizeX,this.sizeY),this}}),re.c("text").requires("draw").defaults({font:"14px sans-serif",textColor:"#000000",textAlign:"left",textBaseline:"top",lineHeight:15}).defines({visible:function(){return this._text&&this._super("draw","visible")},text:function(t){if(re.is(t)){if(t=Array.prototype.join.call(arguments," "),this.text_lines=t.split("\n"),this._text=t,re.sys.context){var e=re.sys.context;e.save(),e.font=this.font,this.sizeX=0;var i=0;for(var s in this.text_lines)i=e.measureText(this.text_lines[s]).width,i>this.sizeX&&(this.sizeX=i);e.restore()}return this.sizeY=this.text_lines.length*this.lineHeight,this}return this._text},draw:function(t){t.font=this.font,t.fillStyle=this.textColor,t.textAlign=this.textAlign,t.textBaseline=this.textBaseline;for(var e=this.text_lines,i=0,s=e.length;s>i;i++)t.fillText(e[i],-this.regX,-this.regY+i*this.lineHeight);return this}}),re.c("keyboard").statics({l:[],focusStop:!0,keyCodes:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",16:"shift",17:"ctrl",18:"alt",24:"cmd",255:"fn",8:"backspace",13:"enter",32:"space",27:"esc",9:"tab",20:"capslock",91:"windows",46:"delete",36:"home",35:"end",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",96:"`",45:"-",187:"=",219:"[",221:"]",220:"\\",59:";",222:"'",188:",",190:".",191:"/"},event:function(t){var e=re.keyboard,i=(t.target||t.srcElement||{}).tagName;if(!(e.focusStop&&i&&i.match(/INPUT|SELECT|TEXTAREA/))){var s=t.keyCode||t.which,r=e.keyCodes[s];re.pressed&&re.pressed.d&&(re.pressed.d[r]="keydown"==t.type),re.preventDefault&&re.preventDefault.d[r]&&t.preventDefault();for(var n=0;n<e.l.length;n++)e.l[n].trigger(t.type,r,t).trigger(t.type+":"+r,r,t)}},i:function(){re.listener("keydown",this.event),re.listener("keyup",this.event),re.listener("focus",function(){re.pressed.d={}})}}).init(function(){re.keyboard.l.push(this)}).dispose(function(){re.keyboard.l.splice(re.keyboard.l.indexOf(this),1)}),re.c("mouse").statics({l:[],press:function(t){var e,i;e=null==t.which?t.button<2?"left":4==t.button?"middle":"right":t.which<2?"left":2==t.which?"middle":"right",i="mouse:"+e,re.pressed.d&&(re.pressed.d[i]="mousedown"==t.type),re.mouse.event(t,i)},event:function(t,e){var i=re.sys.canvas,s=i.width/i.offsetWidth,r=i.height/i.offsetHeight;null!=t.offsetX?(s*=t.offsetX,r*=t.offsetY):(s*=t.layerX-i.offsetLeft,r*=t.layerY-i.offsetTop);for(var n,o,h,a=re.mouse.l,c=0;c<a.length;c++)n=a[c],n.screenable?(o=re.screen.toScreenX(s),h=re.screen.toScreenY(r)):(o=s,h=r),o+=n.offX,h+=n.offY,n.trigger(t.type,o,h,t),e&&n.trigger(t.type+":"+e,o,h,t)},i:function(){var t=re.sys.canvas;re.listener("mousedown",this.press,t),re.listener("mouseup",this.press,t),re.listener("mousemove",this.event,t),re.listener("mouseover",this.event,t),re.listener("mouseout",this.event,t),re.listener("click",this.event,t),re.listener("dblclick",this.event,t),re.listener("contextmenu",this.event,t)}}).defaults({offX:0,offY:0}).init(function(){re.mouse.l.push(this)}).dispose(function(){re.mouse.l.splice(re.mouse.l.indexOf(this),1)}),re.pressed=function(t){var e=arguments;re.is(t,"array")&&(e=t);for(var i=0,s=e.length;s>i;i++)if(re.pressed.d[e[i]])return!0;return!1},re.pressed.d={},re.preventDefault=function(t){re.is(t,"string")&&(t=t.split(" "));for(var e in t)re.preventDefault.d[t[e]]=1},re.preventDefault.d={},re.c("bisect").statics({toX:function(t,e,i){return this.toTileX(t,e,i)*i},toY:function(t,e,i,s){return this.toTileY(t,e,i)*s},toTileX:function(t,e,i){return 0|t%(e/i)},toTileY:function(t,e,i){return 0|t*i/(e-.1)},tileToBi:function(t,e,i,s){return t+e*(i/s)}}).defines({biToX:function(t){return re.bisect.toX(t,this.bisect,this.sizeX)},biToY:function(t){return re.bisect.toY(t,this.bisect,this.sizeX,this.sizeY)},biToTileX:function(t){return re.bisect.toTileX(t,this.bisect,this.sizeX)},biToTileY:function(t){return re.bisect.toTileY(t,this.bisect,this.sizeX)},tileToBi:function(t,e){return re.bisect.tileToBi(t,e,this.bisect,this.sizeX)}}).defaults({bisect:1,sizeX:1,sizeY:1}),re.c("body").defines({hit:function(t,e,i,s,r,n){re.is(t,"object")&&(e=t.posY||t.y,i=t.sizeX||t.w,s=t.sizeY||t.h,r=t.regX||0,n=t.regY||0,t=t.posX||t.x),r=r||0,n=n||0;var o=this.regX||0,h=this.regY||0;return!(t-r>this.posX+this.bodyX-this.padX-o||t+i-r<this.posX+this.padX-o||e-n>this.posY+this.bodyY-this.padY-h||e+s-n<this.posY+this.padY-h)},hitBody:function(t,e,i,s,r,n,o,h){re.is(t,"object")&&(e=t.posY||t.y,i=t.bodyX,s=t.bodyY,r=t.padX,n=t.padY,o=t.regX||0,h=t.regY||0,t=t.posX||t.x),o=o||0,h=h||0;var a=this.regX||0,c=this.regY||0;return!(t+r-o>this.posX+this.bodyX+this.padX-a||t+i-r-o<this.posX+this.padX-a||e+n-h>this.posY+this.bodyY-this.padY-c||e+s-n-h<this.posY+this.padY-c)}}).defaults({posX:0,posY:0,padX:0,padY:0,bodyX:1,bodyY:1}),re.clamp=function(t,e,i){return e>t?e:null!=i&&t>i?i:t},re.distance=function(t,e,i,s){var r,n;return r=i-t,n=s-e,Math.sqrt(r*r+n*n)},re.c("drag").defaults({posX:0,posY:0,dragX:0,dragY:0,dragging:!1}).defines({dragStart:function(t,e){return this.dragging||(this.dragging=!0,this.dragX=t,this.dragY=e,this.trigger("drag:start")),this},dragFinish:function(){return this.dragging=!1,this.trigger("drag:finish")},dragUpdate:function(t,e){return this.dragging&&(this.posX+=t-this.dragX,this.posY+=e-this.dragY,this.dragX=t,this.dragY=e,this.trigger("drag:update")),this}}),re.c("force").requires("update").statics({graX:0,graY:0}).defaults({posX:0,posY:0,velX:0,velY:0,friX:.4,friY:.4,accX:0,accY:0,resX:.4,resY:.4,mass:1}).namespaces({update:function(){this.velX=this.force(this.velX,this.accX,this.friX,this.graX,this.mass),this.velY=this.force(this.velY,this.accY,this.friY,this.graY,this.mass),this.hitmap?this.aftermath(this.hitmap.checkHit(this)):this.aftermath(this.posX+this.velX,this.posY+this.velY)}}).defines({aftermath:function(t,e,i,s,r,n){return re.is(t,"object")&&(i=t.hitX,s=t.hitY,r=t.tarX,n=t.tarY,e=t.posY,t=t.posX),this.posX=t,this.posY=e,i&&(this.velX=this.forceRes(this.velX,this.resX)),s&&(this.velY=this.forceRes(this.velY,this.resY)),this.trigger("aftermath",i,s,r,n)},forceRes:function(t,e){return t*-e},forceGra:function(t,e){return t*e},forceVel:function(t,e,i){return(t+e)*i},force:function(t,e,i,s,r){var n=this.forceVel(t,e,i)+this.forceGra(s,r);return Math.abs(n)<.01&&(n=0),n},isIdle:function(t){return t=t||0,Math.abs(this.velY+this.velX+this.accX+this.accY)<=t}}).init(function(){this.def({hitmap:re.hitmap,graX:re.force.graX,graY:re.force.graY}),this.on("update",this.force_update)}).dispose(function(){this.off("update",this.force_update)}),re.c("hit").defaults({posX:0,posY:0,sizeX:1,sizeY:1,hit:function(t,e,i,s){return re.is(t,"object")&&(e=t.posY||t.y,i=t.sizeX||t.w,s=t.sizeY||t.h,t=t.posX||t.x),!(t>this.posX+this.sizeX||t+i<this.posX||e>this.posY+this.sizeY||e+s<this.posY)}}),re.c("hitmap").requires("automap").defines({hitValue:1,checkAxisX:function(t){return t==this.hitValue},checkAxisY:function(t){return t==this.hitValue},checkHit:function(t,e,i,s,r,n,o,h){re.is(t,"object")&&(i=t.velX,s=t.velY,r=t.bodyX||t.sizeX,n=t.bodyY||t.sizeY,o=t.padX||0,h=t.padY||0,e=t.posY,t=t.posX);var a={posX:t,posY:e},c=0|Math.max(Math.abs(i),Math.abs(s))/(.5*(re.tile.sizeX+re.tile.sizeY))+.5;if(c>1)for(var u=i/c,f=s/c,l=0;c>l&&(u||f);l++)this.hitmap_step(a,t,e,u,f,r,n,h,h),a.hitX&&(u=0),a.hitY&&(f=0);else this.hitmap_step(a,t,e,i,s,r,n,o,h);return a}}).namespaces({step:function(t,e,i,s,r,n,o,h,a){t.posX+=s,t.posY+=r;var c,u,f;if(s){c=re.tile.sizeX;var l=s>0?n-h:h,p=Math.floor((i+a)/c),d=Math.ceil((i+o-a)/c);f=Math.floor((e+s+l)/c);var g=0>s?c:0;if(f>=0&&f<this.lenX&&d>=0&&p<this.lenY)for(u=p;d>u;u++)if(this._automap[u]&&(this.trigger("hit",this._automap[u][f],f,u),this.checkAxisX(this._automap[u][f],e,i,s,r))){t.hitX=!0,t.posX=f*c+g-l,t.tarX=f*c,t.tarY=u*c;break}}if(r){c=re.tile.sizeY;var m=r>0?o-a:a,_=Math.floor((t.posX+h)/c),v=Math.ceil((t.posX+n-h)/c);u=Math.floor((i+r+m)/c);var X=0>r?c:0;if(u>=0&&u<this.lenY&&v>=0&&_<this.lenX)for(f=_;v>f;f++)if(this._automap[u]&&(this.trigger("hit",this._automap[u][f],f,u),this.checkAxisY(this._automap[u][f],e,i,s,r))){t.hitY=!0,t.posY=u*c+X-m,t.tarX=f*c,t.tarY=u*c;break}}}}),re.hitmap=null,re.c("iso").statics({sizeX:30,sizeY:30,sizeZ:30,toPosX:function(t,e){var i=this.toIsoX(t,e),s=this.toIsoY(t,e);return(i-s)*this.sizeX},toPosY:function(t,e){var i=this.toIsoX(t,e),s=this.toIsoY(t,e);return.5*(i+s)*this.sizeY},toPos:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),{posX:this.toPosX(t,e),posY:this.toPosY(t,e)}},toIsoX:function(t,e){var i=.5*(2*e-t),s=t+i;return Math.round(s/this.sizeX)-1},toIsoY:function(t,e){var i=.5*(2*e-t);return Math.round(i/this.sizeY)},toIso:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),{isoX:this.toIsoX(t,e),isoY:this.toIsoY(t,e)}}}).defaults({posX:0,posY:0,posZ:0}).defines({iso:function(t,e,i){if(re.is(t,"object")){if(i=t.z,re.is(t.posZ)&&(i=t.posZ/re.iso.sizeZ),e=t.y,re.is(t.posX)&&re.is(t.posY))return this.posX=t.posX,this.posY=t.posY,t.posZ&&(this.posZ=t.posZ),this;t=t.x}return t=re.is(t)?t:this.isoX(),t*=re.iso.sizeX,e=re.is(e)?e:this.isoY(),e*=re.iso.sizeY,i=re.is(i)?i:this.isoZ(),i*=re.iso.sizeZ,this.posX=t-e,this.posY=.5*(t+e)-i,this.posZ=i,this},isoX:function(t){return re.is(t)?this.iso(t):(this.posX+.5*(2*(this.posY+this.posZ)-this.posX))/re.iso.sizeX},isoY:function(t){return re.is(t)?this.iso({y:t}):.5*(2*(this.posY+this.posZ)-this.posX)/re.iso.sizeY},isoZ:function(t){return re.is(t)?this.iso({z:t}):this.posZ/re.iso.sizeZ},onIso:function(){var t=this.isoX()+this.isoY()+this.isoZ();return(0|t)==t}}),re.c("limit").defines("limit",function(t){var e=arguments;return this[t]<e[1]?this[t]=e[1]:re.is(e[2])&&this[t]>e[2]&&(this[t]=e[2]),this}),re.c("point").defaults({posX:0,posY:0}).defines({pos:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),this.posX=t,this.posY=e,this},distance:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),re.distance(this.posX,this.posY,t,e)}}),re.random=function(t,e){var i=Math.random();if(re.is(t,"array"))return t[0|i*t.length];if(re.is(t,"object")){var s;for(var r in t)(Math.random()<1/++i||!re.is(s))&&(s=r);return s}switch(arguments.length){case 0:return i;case 1:return i*t;case 2:return i*(t-e+1)+e}},re.randomInt=function(){return 0|re.random.apply(this,arguments)},re.range=function(t,e,i){for(var s=[],r=t||0;e>r;r+=i||1)s.push(r);
return s},re.c("tile").statics({sizeX:40,sizeY:40,toPosX:function(t){return this.toTileX(t)*this.sizeX},toPosY:function(t){return this.toTileY(t)*this.sizeY},toPos:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),{posX:this.toPosX(t),posY:this.toPosY(e)}},toTileX:function(t){return 0|(t-.5*this.sizeX)/this.sizeX+.5},toTileY:function(t){return 0|(t-.5*this.sizeY)/this.sizeY+.5},toTile:function(t,e){return re.is(t,"object")&&(e=t.posY||t.y,t=t.posX||t.x),{tileX:this.toTileX(t),tileY:this.toTileY(e)}}}).defaults({posX:0,posY:0,regX:0,regY:0}).defines({tile:function(t,e){return re.is(t,"object")&&(e=t.y||re.tile.toTileY(t.posY),t=t.x||re.tile.toTileX(t.posX)),this.tileX(t),this.tileY(e),this},tileX:function(t){return re.is(t)?(this.posX=0|t*this.sizeX+.5,this):0|this.posX/this.sizeX+.5},tileY:function(t){return re.is(t)?(this.posY=0|t*this.sizeY+.5,this):0|this.posY/this.sizeY+.5}}).init(function(){this.sizeX=re.tile.sizeX,this.sizeY=re.tile.sizeY}),re.c("playlist"),re.c("sound").statics({enabled:!0,volume:1}).defaults({playing:!1}).namespaces({e:0,ended:function(){this.playing=0,this.trigger("sound:finish")}}).defines({play:function(t,e,i){if(!this._sound||!re.sound.enabled)return this;this.playing&&this.stop();var s=this._sound,r=this;if(e=e||re.sound.volume,window.soundManager)s.play({onfinish:function(){r.sound_ended(),i&&i(r)},position:0,volume:e,loops:t||1});else{s.currentTime=0,s.volume=e,t=t||1;var n=function(){--t>0?s.play():(s.removeEventListener("ended",n),r.sound_ended(),i&&i(r))};s.addEventListener("ended",n),s.play()}return this.playing=1,this},stop:function(){return this._sound.pause(),this.playing=0,this}}),re.c("automap").defaults({lenX:0,lenY:0,automapDefault:0}).defines({automap:function(t,e,i){if(re.is(t,"array")){if(e)for(var e=0;e<t.length;e++)for(var s=0;s<t[0].length;s++)this.automap(s,e,t[e][s]);else this._automap=t,this.lenX=t.length>0?t[0].length:0,this.lenY=t.length;return this}if(!re.is(i))return this.within(t,e)?this._automap[e][t]:null;for(;e>=this._automap.length;){var r=new Array(this._automap[0]);for(var n in r)r[n]=this.automapDefault;this._automap.push(r)}for(;t>=this._automap[this._automap.length-1].length;)for(var s=0;s<this._automap.length;s++)this._automap[s].length<=t&&this._automap[s].push(this.automapDefault);return this.lenX=this._automap[e].length,this.lenY=this._automap.length,this._automap[e][t]=i,this},within:function(t,e){return 0>e||e>=this.lenY||0>t||t>=this.lenX?!1:!0}}).init(function(){this._automap=[]}),re.c("flicker").requires("update timestep").interfaces("flick").namespaces({flickering:"",stop:function(){var t=this.flicker_id;return this.flicker_id="",this.stepProgress=0,this.off("update",this.flicker_update),this.trigger("flicker:finish",t)},change:function(){if(this.flicker_frame==this.flicker_frames.length){if(!(-1==this.flicker_loops||--this.flicker_loops>=1))return this.flicker_stop(),void 0;this.flicker_frame=0}this.flicker_run()},run:function(){var t=this.flicker_frame,e=this.flicker_frames,i=this.flicker_loops,s=e[t],r=this.flick(s,t,e,i);this.trigger("flicker:update",s,t,e,i),r===!1&&this.flicker(),this.flicker_frame++},update:function(t){this.timestep(t,this.flicker_change)}}).defines({flicker:function(t,e,i,s){return!re.is(t)&&this.flickering()?this.flicker_stop():(t>=100&&(t/=1e3),this.flicker_duration=t||1,e=re.is(e,"array")?e:[e],this.flicker_loops=i||1,this.stepProgress=0,this.stepSize=t/e.length/re.sys.second,this.flicker_frames=e,this.flicker_frame=0,this.flickering()||this.on("update",this.flicker_update),this.flicker_id=s||!0,this.trigger("flicker:start"),this)},flickering:function(t){return t?this.flicker_id==t:this.flicker_id}}),re.c("pathfind").method(function(){var t=re.e("pathfind"),e=t.pathfind.apply(t,arguments);return t.dispose(),e}).defines({pathfind_max:50,pathfind:function(t,e,i,s,r,n){this.targetX=i,this.targetY=s,this.onCheck=r,this.onTile=n,this.visit={},this.nodes=[],this.addNode(t,e,-1,-1);for(var o,h=0;this.nodes.length;){if(o=this.nodes.shift(),o.x==this.targetX&&o.y==this.targetY)return this.makePath(o);if(this.searchNodes(o.x,o.y,o.px,o.py),++h>=this.pathfind_max)return null}return null},searchNodes:function(t,e){this.addNode(t+1,e,t,e),this.addNode(t-1,e,t,e),this.addNode(t,e+1,t,e),this.addNode(t,e-1,t,e)},checkNode:function(){return!0},makePath:function(t){var e=[],i=0;do e[i++]=t.x,e[i++]=t.y,t=this.nodes[t.px+"_"+t.py];while(t&&-1!=t.px);return e},addNode:function(t,e,i,s){if(!this.checkNode(t,e,i,s)||this.onCheck&&!this.onCheck(t,e,i,s))return!1;var r=t+"_"+e,n=re.distance(t,e,this.targetX,this.targetY);if(!this.nodes[r]||this.nodes[r].cost>n){for(var o=this.nodes[r]={x:t,y:e,cost:n,px:i,py:s},h=!1,a=0,c=this.nodes.length;c>a;a++)if(n<this.nodes[a].cost){this.nodes.splice(a,0,o),h=!0;break}return h||this.nodes.push(o),this.onTile&&this.onTile(t,e,i,s,n),!0}}}),re.c("timestep").defaults({stepProgress:0,stepSize:100}).defines({timestep:function(t,e,i){for(this.stepProgress+=t;this.stepProgress>=this.stepSize&&(e.call(i||this),this.stepProgress-=this.stepSize,this.stepSize););}}),re.c("storage").init(function(t){this.storage=window[t+"Storage"]}).defines({length:function(){return this.storage.length},key:function(t){return this.storage.key(t)},item:function(t,e){return re.is(e)?(this.storage.setItem(t,JSON.stringify(e)),this):JSON.parse(this.storage.getItem(t))},removeItem:function(t){return this.storage.removeItem(t),this},clear:function(){return this.storage.clear(),this}}),re.assert=function(t,e){if(e=e||"",!t)throw"Assert Fail: "+e;re.log("Assert Pass: "+e)},re.clone=function(t){if(!re.is("object"))return t;if(re.is(t,"array"))return t.slice();var e={};for(var i in t)e[i]=t[i];return e},re.extend=function(){var t={};for(var e in arguments)for(var i in arguments[e])t[i]=arguments[e][i];return t},re.log=function(t){console.log(t)},re.c("polyfill").defines({requestAnimationFrame:function(t,e){return requestAnimFrame(t,e)}}).run(function(){requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}),re.c("scene").statics({_scenes:{}}).method(function(t){var e=re.scene;return re.is(t)?(e._scenes[t]||re.e("scene:"+t),e._scenes[t]):e._scenes[re.scene.current]}).init(function(t){re.scene._scenes[t]=this,this.sceneName=t}).dispose(function(){delete re.scene._scenes[this.sceneName]}).defines({clear:function(){return re("el").query("draw").dispose(),this},enter:function(t){return re.is(t,"function")?this.scene_enter=t:(re.scene.current&&re.scene().exit(),re.scene.current=this.sceneName,this.scene_enter&&this.scene_enter.apply(this,arguments)),this},exit:function(t){return re.is(t,"function")?this.scene_exit=t:(re.scene.current="",this.scene_exit&&this.scene_exit.apply(this,arguments)),this}}),re.sheet=function(t,e,i,s){var r=i||re.tile.sizeX,n=s||re.tile.sizeY;re.is(e,"array")&&(e=e.join(" "));var o,h,a=[];for(var c in t)o=t[c][0]||0,h=t[c][1]||0,a.push(c),re.c(c).requires("sprite "+e).defines({frameX:o,frameY:h,sizeX:r,sizeY:n});return a},re.support=function(t){if(arguments.length>1){for(var e,i=0;i<arguments.length;i++)if(e=arguments[i],re.support(e))return e;return!1}var s=t.split(" "),r=!0;for(var n in s)r=r&&!!re.support[s[n]];return r};var c=re.support;c.canvas=!!document.createElement("canvas").getContext,c.text=!(!c.canvas||"function"!=typeof document.createElement("canvas").getContext("2d").fillText);var ele=document.createElement("audio");try{if(c.audio=!!ele.canPlayType){c.ogg=ele.canPlayType('audio/ogg; codecs="vorbis"'),c.wav=ele.canPlayType('audio/wav; codecs="1"'),c.webma=ele.canPlayType('audio/webm; codecs="vorbis"'),c.mp3=ele.canPlayType('audio/mpeg; codecs="mp3"'),c.m4a=ele.canPlayType("audio/mp4; codecs=mp4a.40.2");for(var i in c)("no"==c[i]||""==c[i])&&(c[i]=!1)}}catch(e){}try{c.localstorage=!!localStorage.getItem}catch(e){c.localstorage=!1}c.worker=!!window.Worker,c.webgl=!!window.WebGLRenderingContext,c.touch="ontouchstart"in window,re.c("bit").requires("imgtext bit.png align").defines({imgtext:[8,4,8,12,10,12,12,4,6,6,8,8,6,8,4,12,10,6,10,10,10,10,10,10,10,10,4,4,8,8,8,10,12,10,10,8,10,8,8,10,10,8,10,10,8,12,10,10,10,10,10,10,8,10,10,12,10,10,8,6,12,6,8,10,6,10,10,8,10,10,8,10,10,4,6,10,4,12,10,10,10,10,8,10,8,10,10,12,8,10,10,8,4,8]}),re.c("circle").factory(function(t,e){this.radius=t,this.color=e}).requires("align update").defines({speed:15,color:"#ff0000"}).events({update:function(){re.pressed("a","left")&&(this.posX-=this.speed),re.pressed("d","right")&&(this.posX+=this.speed),re.pressed("w","up")&&(this.posY-=this.speed),re.pressed("s","down")&&(this.posY+=this.speed)}}),re.c("hero").requires("hero.png tsprite update force animate body").defines({speed:40*re.sys.stepSize,friX:.75,friY:.95,padX:6,bodyX:24,bodyY:24,jumpSpeed:20*re.sys.stepSize,jump:!1,ground:!0,update:function(){this.isIdle(.3)&&this.animate("idle")},forceJump:function(){this.jump=!0,this.velY-=.1*this.jumpSpeed,this.animate("jump")},forceDown:function(){for(var t=0;10>t;t++)this.posY+=.2},jumpReset:function(t,e,i,s){e&&(this.jump=!1,this.ground=s>=this.posY)}}).init(function(){this.animates={idle:[800,[0,1],-1],run:[800,[2,3],1],jump:[500,[4,5,4],1],ladder:[500,[6,7],-1]},this.on({update:this.update,aftermath:this.jumpReset})}),re.c("hero_sprite").requires("sprite").init(function(){this.sizeX=re.tile.sizeX,this.sizeY=re.tile.sizeY,this.bodyX=re.tile.sizeX,this.bodyY=re.tile.sizeY,this.regX=.5*this.sizeX,this.regY=.5*this.sizeY}),re.c("tile").requires("tsprite tiles.png"),re.c("tsprite").requires("sprite").init(function(){this.sizeX=re.tile.sizeX,this.sizeY=re.tile.sizeY,this.bodyX=re.tile.sizeX,this.bodyY=re.tile.sizeY,this.regX=.5*this.sizeX,this.regY=.5*this.sizeY}),re.ready(function(){re.sys.init(re.canvas).start(),re.scene("load").enter()}),re.c("coin").requires("item animate").defines({touch:function(){this.collect()},collect:function(){this.sfx.play(),this.trigger("collect"),this.dispose()}}).init(function(){this.comp("coin"),this.sfx=re.e("sound coin.sfx"),this.animates={glow:[1800,[14,15,15],-1]},this.animate("glow")}).alias("t14").alias("t15"),re.c("counter").defines({_count:0,add:function(t){return re.is(t)?(this._count+=t,this.coinText.text("Coins: "+this._count),this):this._count}}).init(function(){this.coinText=re.e("bit").alignLeft(5).alignTop(5).attr("screenable",!1),this.add(0)}).dispose(function(){this.coinText.dispose()}),re.c("spring").requires("item animate").defines({touch:function(){this.hero.velY=-5,re.pressed("w")&&(this.hero.velY=-25,this.animate("bounce"))}}).init(function(){this.animates={bounce:[300,[13,12],1]},this.frame(12),this.comp("spring")}).alias("t12").alias("t13"),re.c("treat").requires("item animate").defines({touch:function(){this.collect()},collect:function(){this.sfx.play(),this.trigger("collect"),this.dispose()}}).init(function(){this.comp("coin"),this.sfx=re.e("sound coin.sfx"),this.animates={glow:[1800,[14,15,15],-1]},this.animate("glow")}).alias("t14").alias("t15"),re.c("level").defines({build:function(){re.hitmap&&re.hitmap.dispose(),re.hitmap=re.e("hitmap"),this.placeTiles(),this.placeHero(),this.placeItems()},teardown:function(){},placeTiles:function(){for(var t=this.layer.data.$,e=0;e<t.length;e++)for(var i=0;i<t[0].length;i++){var s=t[e][i];s&&(s--,re.e("tile").attr({tileX:i,tileY:e,frame:s}),re.hitmap.automap(i,e,1))}},placeItems:function(){var t=this.tileset[2].firstgid,e=this.objectgroup[1].object;for(var i in e){var s=e[i],r=e[i].gid-t;re.e("t"+r).attr({posX:s.x,posY:s.y-re.tile.sizeY,frame:r})}},micController:function(){function t(t){var e=f.createChannelSplitter(2),i=f.createChannelMerger(2);return t.connect(e),e.connect(i,0,0),e.connect(i,0,1),i}function e(){alert("Stream generation failed.")}function i(t,i){try{navigator.webkitGetUserMedia(t,i,e)}catch(s){console.log("webkitGetUserMedia threw exception :"+s)}}function s(e){var i=f.createMediaStreamSource(e);l=f.createAnalyser(),l.fftSize=2048,t(i).connect(l),u()}function r(){i({audio:!0},s)}function n(t){for(var e=Math.ceil(t),i=-1;d>e&&g[e]>128;)e++;if(e>=d)return-1;for(;d>e&&(s=g[e])<m;)s>=128?-1==i&&(i=e):i=-1,e++;if(-1==i&&(i=e),e==d)return-1;if(0==i)return 0;var s=(128-g[i-1])/(g[i]-g[i-1]);return i+s}function o(t){var e=12*(Math.log(t/440)/Math.log(2));return Math.round(e)+69}function h(t){return console.log("frequencyFromNoteNumber: "+440*Math.pow(2,(t-69)/12)),a(440*Math.pow(2,(t-69)/12)),440*Math.pow(2,(t-69)/12)}function a(t){i=t>500?4:t/100;for(var e=0,i=t/100;i>e;e++)hero.forceJump(),console.log("flyFromFrequency() frequency: "+t)}function c(t,e){return Math.floor(1200*Math.log(t/h(e))/Math.log(2))}function u(){var t=new Array;l.getByteTimeDomainData(g);for(var e=0,i=n(0),s=0;-1!=i;){var r=n(i+1);if(r>-1&&t.push(r-i),i=r,s++,s>1e3)break}for(var h=t.length,a=0,m=0,e=0;h>e;e++)a+=t[e];if(h&&(a/=h,m=f.sampleRate/a),h?100*(h/(m*d/f.sampleRate)):0,0!==h){var _=o(m);c(m,_)}p=window.webkitRequestAnimationFrame(u)}var f=new webkitAudioContext,l=null,p=null,d=1024,g=new Uint8Array(d),m=134;r()},placeHero:function(){var t=this.objectgroup[0].object;t.y=155,hero=re.e("hero").attr({posX:t.x,posY:t.y-re.tile.sizeY}),this.micController(hero)}}),re.scene("home").enter(function(){re.scene("play").enter("level1")}).exit(function(){}),re.scene("load").enter(function(){re.tile.sizeX=re.tile.sizeY=25,re.sys.clearColor="#D6F8FA",re.force.graY=0,re.force.graX=.12,re.load(re.assets).complete(function(){re.scene("home").enter()}).error(function(){}).progress(function(){})}).exit(function(){}),re.scene("play").enter(function(t){re.screen.pos(.5*-re.tile.sizeX,.5*-re.tile.sizeY);var e=this.counter=re.e("counter");this.level=re(t+".tmx")[0],this.level.build(),re("coin").on("collect",function(){e.add(1)})}).exit(function(){this.counter.dispose(),this.level.teardown()}),re.c("item").requires("items.png tsprite update hit").namespaces({update:function(t){this.hero.hitBody(this.posX,this.posY,this.sizeX,this.sizeY,10,0)?(this.touching=!0,this.touch(t)):this.touching&&(this.touching=!1,this.untouch(t))}}).defaults({touching:!1,touch:function(){},untouch:function(){}}).init(function(){this.hero=re("hero")[0],this.on("update",this.item_update),this.updateBefore(this.hero)}).dispose(function(){this.off()}),re.e("level level1.tmx").attr({version:1,orientation:"orthogonal",width:20,height:16,tilewidth:25,tileheight:25,tileset:[{firstgid:1,name:"tiles",tilewidth:25,tileheight:25,image:{source:"../images/tiles.png",width:200,height:25}},{firstgid:9,name:"Hero",tilewidth:25,tileheight:25,image:{source:"../images/hero.png",width:225,height:50}},{firstgid:27,name:"items",tilewidth:25,tileheight:25,image:{source:"../images/items.png",width:250,height:50}}],layer:{name:"Base",width:20,height:16,data:{$:[[0,0,0,0,0,0,0,0,0,0,0,0,0,7,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,7,8,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,7,0,0,0,7,7,0,0,0,0,0],[0,0,0,0,0,0,0,0,7,0,0,0,7,0,8,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0],[5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,0,0],[1,2,2,5,0,0,0,0,7,0,0,0,6,2,5,0,0,0,0,0],[1,1,1,3,0,0,6,2,2,5,0,6,1,1,1,5,0,0,0,0],[1,1,1,3,0,6,1,1,1,1,2,1,1,1,1,1,5,0,0,0],[1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]]}},objectgroup:[{color:"#5e3ea4",name:"Hero",width:20,height:16,object:{gid:9,x:0,y:25}},{name:"Items",width:20,height:16,object:[{gid:41,x:350,y:150},{gid:41,x:275,y:300},{gid:41,x:125,y:225},{gid:41,x:425,y:250},{gid:39,x:175,y:300},{gid:39,x:225,y:150},{gid:41,x:125,y:75}]}]}),re.load.path="assets/",re.assets={images:["images/items.png","images/queenplane_sm.gif","images/tiles.png","images/bone.png","images/grid_pieces.png","images/hero.png","images/queenplane_96.gif","images/queenplane_24.gif","images/queenplane_sm.png","images/bit.png"],sounds:["sounds/coin.ogg","sounds/coin.mp3"]},re.canvas="#game-canvas";